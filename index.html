<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Renegocia√ß√£o | Cabanellos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 26px; margin-bottom: 8px; letter-spacing: 2px; font-weight: 300; }
        .header p { font-size: 13px; opacity: 0.9; }
        
        .config-section {
            background: #f0f4f8;
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .config-title {
            font-size: 16px;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .config-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .config-item label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .config-item input, .config-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-section { padding: 20px; background: #f8f9fa; }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2C3E50;
            font-size: 12px;
            text-transform: uppercase;
        }
        .form-field input, .form-field select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }
        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: #C4A35A;
        }
        
        .contracts-section { padding: 20px; }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2C3E50;
        }
        .contract-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 10px;
            align-items: center;
        }
        .contract-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .btn-add {
            background: #C4A35A;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
        }
        .btn-add:hover { background: #B39350; }
        .btn-remove {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-calculate {
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            margin: 20px;
            width: calc(100% - 40px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(196, 163, 90, 0.3);
        }
        
        .results-section { padding: 20px; background: #f8f9fa; }
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 3px solid #C4A35A;
        }
        .info-card-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 4px; }
        .info-card-value { font-size: 20px; font-weight: 700; color: #C4A35A; }
        
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 15px;
        }
        .scenario-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .scenario-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .scenario-card.best {
            border-color: #10b981;
            background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 8px;
        }
        .badge-prazo { background: #8B7355; color: white; }
        .badge-desc { background: #C4A35A; color: white; }
        .badge-ok { background: #10b981; color: white; }
        .badge-no { background: #dc2626; color: white; }
        .badge-best { background: #10b981; color: white; }
        
        .scenario-title { font-size: 14px; font-weight: 600; color: #2C3E50; margin: 10px 0; }
        .scenario-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }
        .result-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
        }
        .result-box.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .result-title { font-size: 11px; opacity: 0.9; margin-bottom: 8px; text-align: center; }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 12px;
        }
        .result-total {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            text-align: center;
        }
        .result-total-value { font-size: 18px; font-weight: 700; }
        
        .alert {
            background: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            .config-grid { grid-template-columns: 1fr 1fr; }
            .input-grid { grid-template-columns: 1fr; }
            .contract-item { grid-template-columns: 1fr; }
            .scenarios-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CABANELLOS</h1>
            <p>Calculadora de Renegocia√ß√£o de D√≠vidas - Configur√°vel</p>
        </div>

        <div class="config-section">
            <div class="config-title" style="cursor: pointer;" onclick="toggleConfig()">
                ‚öôÔ∏è Configura√ß√µes Avan√ßadas 
                <span id="config-toggle" style="font-size: 12px; opacity: 0.7;">(clique para expandir)</span>
            </div>
            <div id="config-content" style="display: none;">
                <div class="config-grid">
                    <div class="config-item">
                        <label>Taxa Mensal (%)</label>
                        <input type="text" id="taxa" value="1,2" placeholder="1,2">
                    </div>
                    <div class="config-item">
                        <label>Prazos (separados por v√≠rgula)</label>
                        <input type="text" id="prazos" value="60, 84, 96, 120, 150" placeholder="60, 84, 96, 120, 150">
                    </div>
                    <div class="config-item">
                        <label>Incremento Desconto (%)</label>
                        <input type="number" id="incremento-desc" value="5" min="1" max="10">
                    </div>
                    <div class="config-item">
                        <label>Status da Liminar</label>
                        <select id="liminar">
                            <option value="deferido">DEFERIDO</option>
                            <option value="indeferido">INDEFERIDO</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div class="config-title">üìä Limites de Desconto por Prazo</div>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 12px;">
                        <div id="limites-desc-container">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <div><strong>48m:</strong> <input type="text" class="limite-desc" data-prazo="48" value="16,88" style="width: 60px;"> %</div>
                                <div><strong>60m:</strong> <input type="text" class="limite-desc" data-prazo="60" value="20,98" style="width: 60px;"> %</div>
                                <div><strong>72m:</strong> <input type="text" class="limite-desc" data-prazo="72" value="24,06" style="width: 60px;"> %</div>
                                <div><strong>84m:</strong> <input type="text" class="limite-desc" data-prazo="84" value="28,17" style="width: 60px;"> %</div>
                                <div><strong>96m:</strong> <input type="text" class="limite-desc" data-prazo="96" value="31,25" style="width: 60px;"> %</div>
                                <div><strong>108m:</strong> <input type="text" class="limite-desc" data-prazo="108" value="33,30" style="width: 60px;"> %</div>
                                <div><strong>120m:</strong> <input type="text" class="limite-desc" data-prazo="120" value="35,00" style="width: 60px;"> %</div>
                                <div><strong>150m:</strong> <input type="text" class="limite-desc" data-prazo="150" value="35,00" style="width: 60px;"> %</div>
                            </div>
                            <div style="margin-top: 10px; color: #64748b; font-size: 11px;">
                                üí° Limites m√°ximos de desconto conforme a planilha. Ajuste conforme necess√°rio.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-grid">
                <div class="form-field">
                    <label>Margem Consign√°vel (R$)</label>
                    <input type="text" id="margem" placeholder="Ex: 1.536,87">
                </div>
                <div class="form-field">
                    <label>Renda (R$) - Opcional</label>
                    <input type="text" id="renda" placeholder="Ex: 5.219,10">
                </div>
            </div>
        </div>

        <div class="contracts-section">
            <div class="section-title">üìã Contratos</div>
            <div id="contracts-container">
                <div class="contract-item">
                    <input type="text" placeholder="Saldo Cont√°bil (R$)" class="contract-saldo">
                    <input type="text" placeholder="PMT Atual (R$)" class="contract-pmt">
                    <button class="btn-remove" onclick="removeContract(this)">‚úï</button>
                </div>
            </div>
            <button class="btn-add" onclick="addContract()">+ Adicionar Contrato</button>
        </div>

        <button class="btn-calculate" onclick="calcular()">üîç CALCULAR CEN√ÅRIOS</button>

        <div class="results-section" id="results" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 15px; color: #2C3E50; font-size: 18px;">üìä Cen√°rios Calculados</h2>
            
            <div class="info-cards">
                <div class="info-card">
                    <div class="info-card-label">Saldo Total</div>
                    <div class="info-card-value" id="info-saldo">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Margem</div>
                    <div class="info-card-value" id="info-margem">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Taxa</div>
                    <div class="info-card-value" id="info-taxa">0%</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Cen√°rios</div>
                    <div class="info-card-value" id="info-cenarios">0</div>
                </div>
            </div>

            <div id="alert-container"></div>
            <div class="scenarios-grid" id="scenarios-grid"></div>
        </div>
    </div>

    <script>
        function toggleConfig() {
            const content = document.getElementById('config-content');
            const toggle = document.getElementById('config-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '(clique para ocultar)';
            } else {
                content.style.display = 'none';
                toggle.textContent = '(clique para expandir)';
            }
        }

        function addContract() {
            const container = document.getElementById('contracts-container');
            const div = document.createElement('div');
            div.className = 'contract-item';
            div.innerHTML = `
                <input type="text" placeholder="Saldo Cont√°bil (R$)" class="contract-saldo">
                <input type="text" placeholder="PMT Atual (R$)" class="contract-pmt">
                <button class="btn-remove" onclick="removeContract(this)">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeContract(btn) {
            const container = document.getElementById('contracts-container');
            if (container.children.length > 1) btn.parentElement.remove();
        }

        function parseBR(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        function formatBR(val) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 }).format(val);
        }

        function calcPMT(saldo, taxaMensal, prazo) {
            if (taxaMensal === 0) return saldo / prazo;
            return (taxaMensal * saldo) / (1 - Math.pow(1 + taxaMensal, -prazo));
        }

        function getMaxDesconto(prazo) {
            // Buscar na tabela configurada
            const limites = {};
            document.querySelectorAll('.limite-desc').forEach(input => {
                const p = parseInt(input.dataset.prazo);
                limites[p] = parseBR(input.value) / 100;
            });
            
            // Encontrar o limite mais pr√≥ximo (igual ou menor)
            let maxDesc = 0;
            const prazosConfig = Object.keys(limites).map(Number).sort((a, b) => a - b);
            
            for (let p of prazosConfig) {
                if (prazo >= p) {
                    maxDesc = limites[p];
                }
            }
            
            return maxDesc;
        }

        function calcular() {
            try {
                const taxaInput = parseBR(document.getElementById('taxa').value) / 100;
                const margem = parseBR(document.getElementById('margem').value);
                const prazosStr = document.getElementById('prazos').value;
                const incrementoDesc = parseInt(document.getElementById('incremento-desc').value) || 5;
                
                if (margem === 0) {
                    alert('Informe a margem consign√°vel!');
                    return;
                }

                // Parse prazos
                const prazos = prazosStr.split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p) && p > 0);
                if (prazos.length === 0) {
                    alert('Informe pelo menos um prazo v√°lido!');
                    return;
                }

                const items = document.querySelectorAll('.contract-item');
                let saldoTotal = 0;

                items.forEach(item => {
                    const saldo = parseBR(item.querySelector('.contract-saldo').value);
                    if (saldo > 0) {
                        saldoTotal += saldo;
                    }
                });

                if (saldoTotal === 0) {
                    alert('Adicione pelo menos um contrato com saldo!');
                    return;
                }

                document.getElementById('info-saldo').textContent = formatBR(saldoTotal);
                document.getElementById('info-margem').textContent = formatBR(margem);
                document.getElementById('info-taxa').textContent = (taxaInput * 100).toFixed(2) + '%';

                const cenarios = [];

                prazos.forEach(prazo => {
                    const maxDesc = getMaxDesconto(prazo);
                    
                    // Testar descontos de 0% at√© o m√°ximo
                    for (let descPct = 0; descPct <= maxDesc * 100 + 0.01; descPct += incrementoDesc) {
                        const desc = descPct / 100;
                        const saldoComDesconto = saldoTotal * (1 - desc);
                        const valorDesconto = saldoTotal * desc;
                        
                        // CALCULAR PMT
                        const pmtCalculado = calcPMT(saldoComDesconto, taxaInput, prazo);
                        
                        // VERIFICAR SE CABE NA MARGEM
                        const cabeNaMargem = pmtCalculado <= margem;
                        const margemSobrando = cabeNaMargem ? (margem - pmtCalculado) : 0;
                        const valorFaltante = !cabeNaMargem ? (pmtCalculado - margem) : 0;
                        
                        const montante = pmtCalculado * prazo;
                        const custo = montante - saldoComDesconto;
                        
                        cenarios.push({
                            prazo,
                            desc: descPct,
                            saldoTotal,
                            saldoComDesconto,
                            valorDesconto,
                            pmtCalculado,
                            cabeNaMargem,
                            margemSobrando,
                            valorFaltante,
                            montante,
                            custo,
                            maxDescPrazo: maxDesc * 100
                        });
                    }
                });

                // Ordenar: primeiro os que cabem, depois por desconto (menor), depois por prazo (maior)
                cenarios.sort((a, b) => {
                    if (a.cabeNaMargem !== b.cabeNaMargem) return a.cabeNaMargem ? -1 : 1;
                    if (a.desc !== b.desc) return a.desc - b.desc;
                    return b.prazo - a.prazo;
                });

                document.getElementById('info-cenarios').textContent = cenarios.length;
                document.getElementById('results').style.display = 'block';
                const grid = document.getElementById('scenarios-grid');
                grid.innerHTML = '';

                const cenariosVi√°veis = cenarios.filter(c => c.cabeNaMargem).length;

                document.getElementById('alert-container').innerHTML = `
                    <div class="alert">
                        <strong>üéØ ${cenarios.length} Cen√°rios Calculados</strong><br>
                        <strong>${cenariosVi√°veis} cen√°rios cabem</strong> na margem de ${formatBR(margem)}.<br>
                        <strong>Taxa:</strong> ${(taxaInput * 100).toFixed(2)}% a.m. | 
                        <strong>Prazos:</strong> ${prazos.join(', ')} meses | 
                        <strong>Incremento:</strong> ${incrementoDesc}%
                    </div>
                `;

                // Mostrar cen√°rios
                const cenariosExibir = cenarios.slice(0, 100);

                cenariosExibir.forEach((c, i) => {
                    const card = document.createElement('div');
                    card.className = 'scenario-card';
                    
                    if (c.cabeNaMargem && c.desc === 0) {
                        card.classList.add('best');
                    }

                    card.innerHTML = `
                        ${c.cabeNaMargem && c.desc === 0 ? '<span class="badge badge-best">üéØ SEM DESCONTO</span>' : ''}
                        <span class="badge badge-prazo">${c.prazo}x</span>
                        <span class="badge badge-desc">${c.desc.toFixed(0)}%</span>
                        <span class="badge ${c.cabeNaMargem ? 'badge-ok' : 'badge-no'}">${c.cabeNaMargem ? '‚úì CABE' : '‚úó N√ÉO CABE'}</span>
                        
                        <div class="scenario-title">${c.prazo} meses com ${c.desc.toFixed(0)}% de desconto</div>
                        
                        <div class="scenario-detail">
                            <span>Saldo Original</span>
                            <strong>${formatBR(c.saldoTotal)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Desconto (${c.desc.toFixed(0)}%)</span>
                            <strong style="color: #dc2626;">- ${formatBR(c.valorDesconto)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Saldo a Negociar</span>
                            <strong>${formatBR(c.saldoComDesconto)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Montante (${c.prazo}x)</span>
                            <strong>${formatBR(c.montante)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Custo da Opera√ß√£o</span>
                            <strong>${formatBR(c.custo)}</strong>
                        </div>
                        <div class="scenario-detail" style="font-size: 10px; color: #888;">
                            <span>Desconto M√°x. (${c.prazo}m)</span>
                            <strong>${c.maxDescPrazo.toFixed(2)}%</strong>
                        </div>
                        
                        <div class="result-box ${c.cabeNaMargem ? '' : 'warning'}">
                            <div class="result-title">${c.cabeNaMargem ? '‚úÖ CABE NA MARGEM' : '‚ö†Ô∏è N√ÉO CABE NA MARGEM'}</div>
                            <div class="result-row">
                                <span>PMT Calculado:</span>
                                <strong>${formatBR(c.pmtCalculado)}</strong>
                            </div>
                            <div class="result-row">
                                <span>Margem Dispon√≠vel:</span>
                                <strong>${formatBR(margem)}</strong>
                            </div>
                            ${c.cabeNaMargem ? `
                            <div class="result-row">
                                <span>Margem Sobrando:</span>
                                <strong>${formatBR(c.margemSobrando)}</strong>
                            </div>
                            ` : `
                            <div class="result-row">
                                <span>Falta por m√™s:</span>
                                <strong>${formatBR(c.valorFaltante)}</strong>
                            </div>
                            `}
                            <div class="result-total">
                                <div style="font-size: 10px; opacity: 0.8;">PARCELA MENSAL</div>
                                <div class="result-total-value">${formatBR(c.pmtCalculado)}</div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                document.getElementById('results').scrollIntoView({behavior: 'smooth'});

            } catch (err) {
                alert('Erro: ' + err.message);
                console.error(err);
            }
        }
    </script>
</body>
</html>
