<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Renegocia√ß√£o | Cabanellos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; letter-spacing: 2px; font-weight: 300; }
        .header p { font-size: 14px; opacity: 0.9; letter-spacing: 1px; }
        .input-section { padding: 30px; background: #f8f9fa; }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-field { display: flex; flex-direction: column; }
        .form-field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2C3E50;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-field select, .form-field input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-field select:focus, .form-field input:focus {
            outline: none;
            border-color: #C4A35A;
        }
        .info-box {
            background: #fff9e6;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #C4A35A;
            grid-column: 1 / -1;
        }
        .info-box-title { font-weight: 600; color: #8B7355; margin-bottom: 8px; font-size: 13px; }
        .info-box-text { font-size: 12px; color: #6B5B47; line-height: 1.5; }
        .contracts-section { padding: 30px; }
        .contracts-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #2C3E50; }
        .contract-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr 100px;
            gap: 15px;
            align-items: center;
        }
        .contract-item input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-add {
            background: #C4A35A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        .btn-add:hover { background: #B39350; }
        .btn-calculate {
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            margin: 30px;
            width: calc(100% - 60px);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(196, 163, 90, 0.3);
        }
        .results-section { padding: 30px; background: #f8f9fa; }
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 3px solid #C4A35A;
        }
        .info-card-label { font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        .info-card-value { font-size: 22px; font-weight: 700; color: #C4A35A; }
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 20px;
        }
        .scenario-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        .scenario-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .scenario-card.best {
            border: 2px solid #10b981;
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
        }
        .scenario-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .prazo-badge {
            display: inline-block;
            background: #8B7355;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }
        .desc-badge {
            display: inline-block;
            background: #C4A35A;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            margin-left: 8px;
        }
        .scenario-title { font-size: 16px; font-weight: 600; color: #2C3E50; margin: 12px 0; }
        .scenario-detail {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .result-box {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .result-title { font-size: 12px; opacity: 0.9; margin-bottom: 10px; text-align: center; }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }
        .result-total {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            text-align: center;
        }
        .result-total-value { font-size: 20px; font-weight: 700; }
        .btn-remove {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-remove:hover { background: #b91c1c; }
        .alert {
            background: #e8f4f8;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .input-group { grid-template-columns: 1fr; }
            .contract-item { grid-template-columns: 1fr; }
            .scenarios-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CABANELLOS</h1>
            <p>Calculadora de Renegocia√ß√£o de D√≠vidas</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <div class="form-field">
                    <label>Status da Liminar</label>
                    <select id="liminar">
                        <option value="deferido">DEFERIDO (Com Liminar)</option>
                        <option value="indeferido">INDEFERIDO (Sem Liminar)</option>
                    </select>
                </div>
                <div class="form-field">
                    <label>Margem Consign√°vel (R$)</label>
                    <input type="text" id="margem" placeholder="Ex: 2.373,71">
                </div>
                <div class="info-box">
                    <div class="info-box-title">üéØ L√≥gica da Calculadora:</div>
                    <div class="info-box-text">
                        <strong>1. Esgota a Margem:</strong> Usa 100% da margem dispon√≠vel no consignado<br>
                        <strong>2. Joga o Restante na Conta:</strong> O que n√£o cabe vai para d√©bito em conta<br>
                        <strong>3. Descontos Progressivos:</strong> 0%, 5%, 10%, 15%, etc conforme regras do prazo
                    </div>
                </div>
            </div>
        </div>

        <div class="contracts-section">
            <div class="contracts-title">üìã Contratos</div>
            <div id="contracts-container">
                <div class="contract-item">
                    <input type="text" placeholder="Saldo (R$)" class="contract-saldo">
                    <input type="text" placeholder="PMT Atual (R$)" class="contract-pmt">
                    <button class="btn-remove" onclick="removeContract(this)">Remover</button>
                </div>
            </div>
            <button class="btn-add" onclick="addContract()">+ Adicionar Contrato</button>
        </div>

        <button class="btn-calculate" onclick="calcular()">üîç CALCULAR CEN√ÅRIOS</button>

        <div class="results-section" id="results" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #2C3E50;">üìä Cen√°rios de Renegocia√ß√£o</h2>
            
            <div class="info-cards">
                <div class="info-card">
                    <div class="info-card-label">Saldo Total</div>
                    <div class="info-card-value" id="info-saldo">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Margem</div>
                    <div class="info-card-value" id="info-margem">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">PMT Atual</div>
                    <div class="info-card-value" id="info-pmt">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Cen√°rios</div>
                    <div class="info-card-value" id="info-cenarios">0</div>
                </div>
            </div>

            <div id="alert-container"></div>
            <div class="scenarios-grid" id="scenarios-grid"></div>
        </div>
    </div>

    <script>
        function addContract() {
            const container = document.getElementById('contracts-container');
            const div = document.createElement('div');
            div.className = 'contract-item';
            div.innerHTML = `
                <input type="text" placeholder="Saldo (R$)" class="contract-saldo">
                <input type="text" placeholder="PMT Atual (R$)" class="contract-pmt">
                <button class="btn-remove" onclick="removeContract(this)">Remover</button>
            `;
            container.appendChild(div);
            addInputListeners();
        }

        function removeContract(btn) {
            const container = document.getElementById('contracts-container');
            if (container.children.length > 1) btn.parentElement.remove();
        }

        function parseBR(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        function formatBR(val) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 }).format(val);
        }

        function formatInput(input) {
            const valor = parseBR(input.value);
            if (valor > 0) {
                input.value = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }

        function addInputListeners() {
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.removeEventListener('blur', handleBlur);
                input.addEventListener('blur', handleBlur);
            });
        }

        function handleBlur(e) {
            if (e.target.classList.contains('contract-saldo') || e.target.classList.contains('contract-pmt') || e.target.id === 'margem') {
                formatInput(e.target);
            }
        }

        function getMaxDesc(prazo, liminar) {
            if (prazo <= 84) return liminar ? 0.35 : 0.20;
            if (prazo <= 96) return liminar ? 0.25 : 0.20;
            if (prazo <= 149) return 0.15;
            return 0.10;
        }

        // Calcular saldo que cabe na margem dado PMT, taxa e prazo
        function calcSaldoFromPMT(pmt, taxa, prazo) {
            if (taxa === 0) return pmt * prazo;
            return pmt * (1 - Math.pow(1 + taxa, -prazo)) / taxa;
        }

        function calcular() {
            try {
                const liminar = document.getElementById('liminar').value === 'deferido';
                const margem = parseBR(document.getElementById('margem').value);
                
                if (margem === 0) {
                    alert('Informe a margem consign√°vel!');
                    return;
                }

                const items = document.querySelectorAll('.contract-item');
                let pmtAtual = 0, saldoTotal = 0;

                items.forEach(item => {
                    const saldo = parseBR(item.querySelector('.contract-saldo').value);
                    const pmt = parseBR(item.querySelector('.contract-pmt').value);
                    if (saldo > 0) {
                        saldoTotal += saldo;
                        pmtAtual += pmt;
                    }
                });

                if (saldoTotal === 0) {
                    alert('Adicione pelo menos um contrato com saldo!');
                    return;
                }

                document.getElementById('info-saldo').textContent = formatBR(saldoTotal);
                document.getElementById('info-margem').textContent = formatBR(margem);
                document.getElementById('info-pmt').textContent = formatBR(pmtAtual);

                // PRAZOS FIXOS para consignado (sem prazos muito pr√≥ximos)
                const prazosConsignado = [60, 84, 96, 120, 150];
                const taxa = 0.012; // 1.2% a.m.
                const cenarios = [];

                prazosConsignado.forEach(prazoConsig => {
                    const maxDesc = getMaxDesc(prazoConsig, liminar);
                    
                    // Calcula quanto de saldo cabe na margem com esse prazo
                    const saldoQueCabe = calcSaldoFromPMT(margem, taxa, prazoConsig);
                    
                    // Testar descontos de 0% at√© o m√°ximo (5% em 5%)
                    for (let desc = 0; desc <= maxDesc + 0.001; desc += 0.05) {
                        const descArredondado = Math.round(desc * 100) / 100;
                        const saldoComDesconto = saldoTotal * (1 - descArredondado);
                        const valorDesconto = saldoTotal * descArredondado;
                        
                        // Quanto sobra para d√©bito em conta?
                        const valorParaDebito = saldoComDesconto - saldoQueCabe;
                        
                        if (valorParaDebito <= 0) {
                            // CABE TUDO NA MARGEM (com ou sem desconto)
                            cenarios.push({
                                tipo: 'MARGEM',
                                prazoConsig,
                                desc: descArredondado * 100,
                                saldoTotal,
                                saldoComDesconto,
                                valorDesconto,
                                pmtConsig: margem,
                                saldoNaMargem: saldoComDesconto,
                                saldoNoDebito: 0,
                                prazoDebito: 0,
                                pmtDebito: 0,
                                totalMensal: margem,
                                montanteConsig: margem * prazoConsig,
                                montanteDebito: 0,
                                montanteTotal: margem * prazoConsig
                            });
                        } else {
                            // PRECISA DE D√âBITO EM CONTA
                            // Prazos estrat√©gicos de d√©bito (sem prazos muito pr√≥ximos)
                            const prazosDebito = [60, 84, 96, 120, 150];
                            
                            prazosDebito.forEach(prazoDebito => {
                                const pmtDebito = valorParaDebito / prazoDebito;
                                
                                cenarios.push({
                                    tipo: 'MARGEM + D√âBITO',
                                    prazoConsig,
                                    desc: descArredondado * 100,
                                    saldoTotal,
                                    saldoComDesconto,
                                    valorDesconto,
                                    pmtConsig: margem,
                                    saldoNaMargem: saldoQueCabe,
                                    saldoNoDebito: valorParaDebito,
                                    prazoDebito,
                                    pmtDebito,
                                    totalMensal: margem + pmtDebito,
                                    montanteConsig: margem * prazoConsig,
                                    montanteDebito: pmtDebito * prazoDebito,
                                    montanteTotal: (margem * prazoConsig) + (pmtDebito * prazoDebito)
                                });
                            });
                        }
                    }
                });

                // Ordenar: primeiro por desconto (menor), depois por prazo (maior)
                cenarios.sort((a, b) => {
                    if (a.desc !== b.desc) return a.desc - b.desc;
                    return b.prazoConsig - a.prazoConsig;
                });

                document.getElementById('info-cenarios').textContent = cenarios.length;
                document.getElementById('results').style.display = 'block';
                const grid = document.getElementById('scenarios-grid');
                grid.innerHTML = '';

                document.getElementById('alert-container').innerHTML = `
                    <div class="alert">
                        <strong>üéØ ${cenarios.length} Cen√°rios Calculados</strong><br>
                        <strong>L√≥gica:</strong> Esgota a margem de ${formatBR(margem)} e joga o restante em d√©bito.<br>
                        <strong>Descontos:</strong> 0% at√© ${(getMaxDesc(84, liminar) * 100).toFixed(0)}% (conforme prazo e liminar).<br>
                        <strong>Dica:</strong> Filtre pelos cen√°rios que se encaixam no perfil do cliente!
                    </div>
                `;

                // Mostrar apenas os primeiros 50 cen√°rios
                const cenariosExibir = cenarios.slice(0, 50);

                cenariosExibir.forEach((c, i) => {
                    const card = document.createElement('div');
                    card.className = 'scenario-card';
                    
                    if (c.desc === 0 && c.tipo === 'MARGEM') {
                        card.classList.add('best');
                    }

                    card.innerHTML = `
                        ${c.desc === 0 && c.tipo === 'MARGEM' ? '<span class="scenario-badge">üéØ SEM DESCONTO</span>' : ''}
                        <div style="margin-bottom: 10px;">
                            <span class="prazo-badge">${c.prazoConsig}x CONSIG</span>
                            <span class="desc-badge">${c.desc.toFixed(0)}% DESC</span>
                            ${c.prazoDebito > 0 ? `<span class="prazo-badge" style="background: #3b82f6;">${c.prazoDebito}x D√âBITO</span>` : ''}
                        </div>
                        
                        <div class="scenario-title">${c.tipo}</div>
                        
                        <div class="scenario-detail">
                            <span>Saldo Original</span>
                            <strong>${formatBR(c.saldoTotal)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Desconto (${c.desc.toFixed(0)}%)</span>
                            <strong style="color: #dc2626;">- ${formatBR(c.valorDesconto)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Saldo a Negociar</span>
                            <strong>${formatBR(c.saldoComDesconto)}</strong>
                        </div>
                        
                        ${c.tipo === 'MARGEM + D√âBITO' ? `
                        <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #3b82f6;">
                            <div class="scenario-detail" style="border: none;">
                                <span>Na Margem (${c.prazoConsig}x):</span>
                                <strong>${formatBR(c.saldoNaMargem)}</strong>
                            </div>
                            <div class="scenario-detail" style="border: none;">
                                <span>No D√©bito (${c.prazoDebito}x):</span>
                                <strong>${formatBR(c.saldoNoDebito)}</strong>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="result-box">
                            <div class="result-title">üí∞ RESULTADO FINAL</div>
                            <div class="result-row">
                                <span>Consignado (${c.prazoConsig}x):</span>
                                <strong>${formatBR(c.pmtConsig)}</strong>
                            </div>
                            ${c.pmtDebito > 0 ? `
                            <div class="result-row">
                                <span>D√©bito em Conta (${c.prazoDebito}x):</span>
                                <strong>${formatBR(c.pmtDebito)}</strong>
                            </div>
                            ` : ''}
                            <div class="result-total">
                                <div style="font-size: 11px; opacity: 0.8;">TOTAL MENSAL</div>
                                <div class="result-total-value">${formatBR(c.totalMensal)}</div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 11px; color: #666;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Montante Consig:</span>
                                <strong>${formatBR(c.montanteConsig)}</strong>
                            </div>
                            ${c.montanteDebito > 0 ? `
                            <div style="display: flex; justify-content: space-between;">
                                <span>Montante D√©bito:</span>
                                <strong>${formatBR(c.montanteDebito)}</strong>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 5px; margin-top: 5px;">
                                <span>Montante Total:</span>
                                <strong>${formatBR(c.montanteTotal)}</strong>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                document.getElementById('results').scrollIntoView({behavior: 'smooth'});

            } catch (err) {
                alert('Erro: ' + err.message);
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', addInputListeners);
    </script>
</body>
</html>
