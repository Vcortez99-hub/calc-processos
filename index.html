<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Renegocia√ß√£o | Cabanellos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 26px; margin-bottom: 8px; letter-spacing: 2px; font-weight: 300; }
        .header p { font-size: 13px; opacity: 0.9; }
        
        .config-section {
            background: #f0f4f8;
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .config-title {
            font-size: 16px;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .config-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .config-item label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .config-item input, .config-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-section { padding: 20px; background: #f8f9fa; }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #2C3E50;
            font-size: 12px;
            text-transform: uppercase;
        }
        .form-field input, .form-field select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }
        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: #C4A35A;
        }
        
        .contracts-section { padding: 20px; }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2C3E50;
        }
        .contract-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 10px;
            align-items: center;
        }
        .contract-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .btn-add {
            background: #C4A35A;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
        }
        .btn-add:hover { background: #B39350; }
        .btn-remove {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-calculate {
            background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            margin: 20px;
            width: calc(100% - 40px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(196, 163, 90, 0.3);
        }
        
        .results-section { padding: 20px; background: #f8f9fa; }
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 3px solid #C4A35A;
        }
        .info-card-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 4px; }
        .info-card-value { font-size: 20px; font-weight: 700; color: #C4A35A; }
        
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 15px;
        }
        .scenario-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .scenario-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .scenario-card.best {
            border-color: #10b981;
            background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 8px;
        }
        .badge-prazo { background: #8B7355; color: white; }
        .badge-desc { background: #C4A35A; color: white; }
        .badge-ok { background: #10b981; color: white; }
        .badge-no { background: #dc2626; color: white; }
        .badge-best { background: #10b981; color: white; }
        
        .scenario-title { font-size: 14px; font-weight: 600; color: #2C3E50; margin: 10px 0; }
        .scenario-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }
        .result-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
        }
        .result-box.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .result-title { font-size: 11px; opacity: 0.9; margin-bottom: 8px; text-align: center; }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 12px;
        }
        .result-total {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            text-align: center;
        }
        .result-total-value { font-size: 18px; font-weight: 700; }
        
        .alert {
            background: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            .config-grid { grid-template-columns: 1fr 1fr; }
            .input-grid { grid-template-columns: 1fr; }
            .contract-item { grid-template-columns: 1fr; }
            .scenarios-grid { grid-template-columns: 1fr; }
        }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: linear-gradient(135deg, #C4A35A 0%, #8B7355 100%); color: white; }
        .modal-body { padding: 16px; overflow: auto; background: #f8f9fa; }
        .modal-close { background: transparent; border: none; color: white; font-size: 18px; cursor: pointer; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 16px; background: #f3f4f6; }
        .btn-detail { background: #C4A35A; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; margin-top: 10px; }
        .btn-detail:hover { background: #B39350; }
        .btn-primary { background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-export { background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: right; }
        .table th:first-child, .table td:first-child { text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CABANELLOS</h1>
            <p>Calculadora de Renegocia√ß√£o de D√≠vidas - Configur√°vel</p>
        </div>

        <div class="config-section">
            <div class="config-title" style="cursor: pointer;" onclick="toggleConfig()">
                ‚öôÔ∏è Configura√ß√µes Avan√ßadas 
                <span id="config-toggle" style="font-size: 12px; opacity: 0.7;">(clique para recolher)</span>
            </div>
            <div id="config-content" style="display: block;">
                <div class="config-grid">
                    <div class="config-item">
                        <label>Taxa Mensal (%)</label>
                        <input type="text" id="taxa" value="1,2" placeholder="1,2">
                    </div>
                    <div class="config-item">
                        <label>Prazos (separados por v√≠rgula)</label>
                        <input type="text" id="prazos" value="60, 84, 96, 120, 150" placeholder="60, 84, 96, 120, 150">
                    </div>
                    <div class="config-item">
                        <label>Incremento Desconto (%)</label>
                        <input type="number" id="incremento-desc" value="5" min="1" max="10">
                    </div>
                    <div class="config-item">
                        <label>Status da Liminar</label>
                        <select id="liminar">
                            <option value="deferido">DEFERIDO</option>
                            <option value="indeferido">INDEFERIDO</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 12px;">
                        <div style="color: #64748b;">
                            <strong>üìä Regras de Desconto Aplicadas:</strong><br><br>
                            <strong>COM LIMINAR (Deferido):</strong><br>
                            ‚Ä¢ At√© 84 meses: <strong>35%</strong><br>
                            ‚Ä¢ 85-96 meses: <strong>25%</strong><br>
                            ‚Ä¢ 97-149 meses: <strong>15%</strong><br>
                            ‚Ä¢ 150 meses: <strong>10%</strong><br><br>
                            <strong>SEM LIMINAR (Indeferido):</strong><br>
                            ‚Ä¢ At√© 84 meses: <strong>20%</strong><br>
                            ‚Ä¢ 85-116 meses: <strong>15%</strong><br>
                            ‚Ä¢ 117-150 meses: <strong>10%</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);">
            <div style="background: #f59e0b; color: white; padding: 8px 15px; margin: -15px -15px 15px -15px; border-radius: 8px 8px 0 0; font-weight: 600;">
                ‚≠ê Dados Principais - Preencha aqui
            </div>
            <div class="input-grid">
                <div class="form-field">
                    <label style="font-weight: 600; color: #92400e;">Margem Consign√°vel (R$) *</label>
                    <input type="text" id="margem" placeholder="Ex: 1.536,87" style="border: 2px solid #f59e0b; font-size: 16px; font-weight: 600;">
                </div>
                <div class="form-field">
                    <label style="color: #92400e;">Renda (R$) - Opcional</label>
                    <input type="text" id="renda" placeholder="Ex: 5.219,10">
                </div>
            </div>
        </div>

        <div class="contracts-section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);">
            <div style="background: #f59e0b; color: white; padding: 8px 15px; margin: -15px -15px 15px -15px; border-radius: 8px 8px 0 0; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                <span>üìã Contratos - Adicione os saldos</span>
                <button onclick="adicionarContrato()" style="background: white; color: #f59e0b; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">
                    + Adicionar Contrato
                </button>
            </div>
            <div class="section-title" style="display: none;">üìã Contratos</div>
            <div id="contracts-container">
                <div class="contract-item">
                    <input type="text" placeholder="Saldo Cont√°bil (R$)" class="contract-saldo">
                    <input type="text" placeholder="PMT Atual (R$)" class="contract-pmt">
                    <button class="btn-remove" onclick="removeContract(this)">‚úï</button>
                </div>
            </div>
            <button class="btn-add" onclick="addContract()">+ Adicionar Contrato</button>
        </div>

        <button class="btn-calculate" onclick="calcular()">üîç CALCULAR CEN√ÅRIOS</button>

        <div class="results-section" id="results" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 15px; color: #2C3E50; font-size: 18px;">üìä Cen√°rios Calculados</h2>
            
            <div class="info-cards">
                <div class="info-card">
                    <div class="info-card-label">Saldo Total</div>
                    <div class="info-card-value" id="info-saldo">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Margem</div>
                    <div class="info-card-value" id="info-margem">R$ 0</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Taxa</div>
                    <div class="info-card-value" id="info-taxa">0%</div>
                </div>
                <div class="info-card">
                    <div class="info-card-label">Cen√°rios</div>
                    <div class="info-card-value" id="info-cenarios">0</div>
                </div>
            </div>

            <div id="alert-container"></div>
            <div class="scenarios-grid" id="scenarios-grid"></div>
        </div>
        <div id="parcelas-modal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <div id="modal-title" style="font-weight:700;"></div>
                    <button class="modal-close" onclick="fecharParcelas()">‚úï</button>
                </div>
                <div class="modal-body" id="modal-body"></div>
                <div class="modal-actions">
                    <button class="btn-export" onclick="exportarParcelas()">Exportar CSV</button>
                    <button class="btn-primary" onclick="fecharParcelas()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleConfig() {
            const content = document.getElementById('config-content');
            const toggle = document.getElementById('config-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '(clique para ocultar)';
            } else {
                content.style.display = 'none';
                toggle.textContent = '(clique para expandir)';
            }
        }

        function addContract() {
            const container = document.getElementById('contracts-container');
            const div = document.createElement('div');
            div.className = 'contract-item';
            div.innerHTML = `
                <input type="text" placeholder="Saldo Cont√°bil (R$)" class="contract-saldo">
                <input type="text" placeholder="PMT Atual (R$)" class="contract-pmt">
                <button class="btn-remove" onclick="removeContract(this)">‚úï</button>
            `;
            container.appendChild(div);
        }

        function removeContract(btn) {
            const container = document.getElementById('contracts-container');
            if (container.children.length > 1) btn.parentElement.remove();
        }

        function parseBR(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        function formatBR(val) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2 }).format(val);
        }

        function calcPMT(saldo, taxaMensal, prazo) {
            if (taxaMensal === 0) return saldo / prazo;
            return (taxaMensal * saldo) / (1 - Math.pow(1 + taxaMensal, -prazo));
        }

        function getMaxDesconto(prazo, liminar) {
            // REGRAS OFICIAIS DE DESCONTO
            if (liminar) {
                // COM LIMINAR (DEFERIDO)
                if (prazo <= 84) return 0.35;      // 35%
                if (prazo <= 96) return 0.25;      // 25%
                if (prazo <= 149) return 0.15;     // 15%
                return 0.10;                        // 10% (150+)
            } else {
                // SEM LIMINAR (INDEFERIDO)
                if (prazo <= 84) return 0.20;      // 20%
                if (prazo <= 116) return 0.15;     // 15%
                if (prazo <= 150) return 0.10;     // 10%
                return 0.10;                        // 10% (acima de 150)
            }
        }

        function calcular() {
            try {
                const taxaInput = parseBR(document.getElementById('taxa').value) / 100;
                const margem = parseBR(document.getElementById('margem').value);
                window.margemAtual = margem;
                const prazosStr = document.getElementById('prazos').value;
                const incrementoDesc = parseInt(document.getElementById('incremento-desc').value) || 5;
                const liminar = document.getElementById('liminar').value === 'deferido';
                
                if (margem === 0) {
                    alert('Informe a margem consign√°vel!');
                    return;
                }

                // Parse prazos
                const prazos = prazosStr.split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p) && p > 0);
                if (prazos.length === 0) {
                    alert('Informe pelo menos um prazo v√°lido!');
                    return;
                }

                const items = document.querySelectorAll('.contract-item');
                let saldoTotal = 0;

                items.forEach(item => {
                    const saldo = parseBR(item.querySelector('.contract-saldo').value);
                    if (saldo > 0) {
                        saldoTotal += saldo;
                    }
                });

                if (saldoTotal === 0) {
                    alert('Adicione pelo menos um contrato com saldo!');
                    return;
                }

                document.getElementById('info-saldo').textContent = formatBR(saldoTotal);
                document.getElementById('info-margem').textContent = formatBR(margem);
                document.getElementById('info-taxa').textContent = (taxaInput * 100).toFixed(2) + '%';
                
                // Salvar valores globalmente para o detalhamento
                window.dadosGlobais = {
                    saldoTotal,
                    margem,
                    taxa: taxaInput * 100
                };

                const cenarios = [];

                prazos.forEach(prazo => {
                    const maxDesc = getMaxDesconto(prazo, liminar);

                    // Testar descontos de 0% at√© o m√°ximo
                    for (let descPct = 0; descPct <= maxDesc * 100 + 0.01; descPct += incrementoDesc) {
                        const descAplicado = descPct / 100; // Desconto aplicado (ex: 15%)
                        const valorDescontoAplicado = saldoTotal * descAplicado;
                        const saldoComDesconto = saldoTotal - valorDescontoAplicado;

                        // CALCULAR PMT com o desconto aplicado
                        const pmtComDescontoAplicado = calcPMT(saldoComDesconto, taxaInput, prazo);

                        // VERIFICAR SE CABE NA MARGEM
                        const cabeNaMargem = pmtComDescontoAplicado <= margem;

                        let descontoParaDebito = 0; // Desconto adicional que vai para d√©bito (%)
                        let valorDescontoDebito = 0; // Valor do desconto adicional
                        let pmtConsignado, pmtDebito, prazoDebito;
                        let saldoConsignado, saldoDebito;

                        if (cabeNaMargem) {
                            // ‚úÖ CABE NA MARGEM
                            pmtConsignado = pmtComDescontoAplicado;
                            saldoConsignado = saldoComDesconto;

                            // D√©bito = valor do desconto aplicado (financiado em at√© 120x)
                            prazoDebito = Math.min(120, prazo);
                            saldoDebito = valorDescontoAplicado;
                            pmtDebito = valorDescontoAplicado > 0 ? calcPMT(valorDescontoAplicado, taxaInput, prazoDebito) : 0;
                            descontoParaDebito = 0; // N√£o precisa desconto adicional

                        } else {
                            // ‚ùå N√ÉO CABE NA MARGEM
                            // Buscar desconto ADICIONAL que faz PMT caber

                            let descontoTotal = descAplicado;
                            let saldoTeste = saldoComDesconto;
                            let pmtTeste = pmtComDescontoAplicado;

                            // Aumenta desconto at√© PMT ficar MENOR que margem (limite 95%)
                            while (pmtTeste > margem && descontoTotal < 0.95) {
                                descontoTotal += 0.01; // Aumenta 1%
                                saldoTeste = saldoTotal * (1 - descontoTotal);
                                pmtTeste = calcPMT(saldoTeste, taxaInput, prazo);
                            }

                            // Usar PMT calculado (N√ÉO for√ßa margem completa)
                            pmtConsignado = pmtTeste;
                            saldoConsignado = saldoTeste;

                            // Desconto para d√©bito = diferen√ßa entre total e aplicado
                            descontoParaDebito = (descontoTotal - descAplicado) * 100; // Em %
                            valorDescontoDebito = (saldoTotal * descontoTotal) - valorDescontoAplicado;

                            // D√©bito = desconto aplicado + desconto adicional
                            prazoDebito = Math.min(120, prazo);
                            saldoDebito = valorDescontoAplicado + valorDescontoDebito;
                            pmtDebito = calcPMT(saldoDebito, taxaInput, prazoDebito);
                        }

                        // Valores para exibi√ß√£o
                        const margemSobrando = cabeNaMargem ? (margem - pmtConsignado) : 0;
                        const valorTotalDebito = pmtDebito * prazoDebito;
                        const totalMensal = pmtConsignado + pmtDebito;

                        // Montante e custo
                        const montanteConsignado = pmtConsignado * prazo;
                        const montanteDebito = valorTotalDebito;
                        const montanteTotal = montanteConsignado + montanteDebito;
                        const custoTotal = montanteTotal - saldoTotal;

                        // Viabilidade
                        const viavel = cabeNaMargem;

                        cenarios.push({
                            prazo,
                            desc: descPct, // Desconto aplicado (%)
                            descAplicado,
                            descontoParaDebito, // Desconto adicional para d√©bito (%)
                            valorDescontoAplicado,
                            valorDescontoDebito,
                            saldoTotal,
                            saldoComDesconto,
                            saldoConsignado,
                            saldoDebito,
                            pmtCalculado: pmtComDescontoAplicado,
                            pmtConsignado,
                            pmtDebito,
                            cabeNaMargem,
                            margemSobrando,
                            valorTotalDebito,
                            prazoDebito,
                            totalMensal,
                            montante: montanteTotal,
                            montanteConsignado,
                            montanteDebito,
                            custo: custoTotal,
                            maxDescPrazo: maxDesc * 100,
                            viavel
                        });
                    }
                });

                // Ordenar: primeiro os vi√°veis, depois por tipo (cabe na margem), depois por desconto (menor), depois por prazo (maior)
                cenarios.sort((a, b) => {
                    if (a.viavel !== b.viavel) return a.viavel ? -1 : 1;
                    if (a.cabeNaMargem !== b.cabeNaMargem) return a.cabeNaMargem ? -1 : 1;
                    if (a.desc !== b.desc) return a.desc - b.desc;
                    return b.prazo - a.prazo;
                });

                const totalCenarios = cenarios.length;
                window.cenariosCalculados = cenarios;

                document.getElementById('info-cenarios').textContent = totalCenarios;
                document.getElementById('results').style.display = 'block';
                const grid = document.getElementById('scenarios-grid');
                grid.innerHTML = '';

                const margemAnual = margem * 12;
                const dividaBaixa = saldoTotal <= (margemAnual * 2);

                const cenariosViaveis = cenarios.filter(c => c.viavel).length;
                const cenariosComReforco = cenarios.filter(c => !c.viavel).length;

                document.getElementById('alert-container').innerHTML = `
                    <div class="alert" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="flex: 1; min-width: 300px;">
                            <strong>üìä ${totalCenarios} Cen√°rios Gerados</strong>
                            <br><span style="color: #059669; font-weight: 600;">${cenariosViaveis} sem refor√ßo</span> |
                            <span style="color: #2563eb; font-weight: 600;">${cenariosComReforco} com d√©bito</span>
                            <br><strong>Taxa:</strong> ${(taxaInput * 100).toFixed(2)}% a.m. |
                            <strong>Incremento:</strong> ${incrementoDesc}%
                        </div>
                        <button onclick="gerarDetalhamento()" style="background: linear-gradient(135deg, #b8860b 0%, #967209 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 8px rgba(184, 134, 11, 0.3); white-space: nowrap;">
                            üìã Ver Detalhamento
                        </button>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="font-weight: 600; margin-bottom: 10px; color: #2C3E50;">üîç Filtrar por Parcelas</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="filtrarCenarios('todos')" class="btn-filtro" data-filtro="todos" style="background: #C4A35A; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                Todos (${totalCenarios})
                            </button>
                            ${prazos.map(p => {
                                const count = cenarios.filter(c => c.prazo === p).length;
                                return `<button onclick="filtrarCenarios(${p})" class="btn-filtro" data-filtro="${p}" style="background: #e2e8f0; color: #334155; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                    ${p}x (${count})
                                </button>`;
                            }).join('')}
                            <button onclick="filtrarCenarios('viavel')" class="btn-filtro" data-filtro="viavel" style="background: #e2e8f0; color: #334155; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                ‚úì Sem Refor√ßo (${cenariosViaveis})
                            </button>
                            <button onclick="filtrarCenarios('reforco')" class="btn-filtro" data-filtro="reforco" style="background: #e2e8f0; color: #334155; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                üí≥ Com D√©bito (${cenariosComReforco})
                            </button>
                        </div>
                    </div>
                `;

                // Salvar todos os cen√°rios e prazos globalmente para filtros
                window.todosCenarios = cenarios;
                window.prazosDisponiveis = prazos;

                // Renderizar cen√°rios inicialmente
                renderizarCenarios(cenarios, margem);

                document.getElementById('results').scrollIntoView({behavior: 'smooth'});

            } catch (err) {
                alert('Erro: ' + err.message);
                console.error(err);
            }
        }

        function renderizarCenarios(cenarios, margem) {
            const grid = document.getElementById('scenarios-grid');
            grid.innerHTML = '';
            const cenariosExibir = cenarios.slice(0, 100);
            window.cenariosExibir = cenariosExibir;

            cenariosExibir.forEach((c, i) => {
                    const card = document.createElement('div');
                    card.className = 'scenario-card';
                    
                    if (c.cabeNaMargem && c.desc === 0) {
                        card.classList.add('best');
                    }

                    card.innerHTML = `
                        ${c.cabeNaMargem && c.desc === 0 ? '<span class="badge badge-best">üéØ SEM DESCONTO</span>' : ''}
                        <span class="badge badge-prazo">${c.prazo}x CONSIG</span>
                        <span class="badge badge-desc">${c.desc.toFixed(0)}%</span>
                        ${!c.cabeNaMargem ? `<span class="badge" style="background: #3b82f6; color: white;">${c.prazoDebito}x D√âBITO</span>` : ''}
                        
                        <div class="scenario-title">${c.prazo} meses com ${c.desc.toFixed(0)}% de desconto</div>
                        
                        <div class="scenario-detail">
                            <span>Saldo Original</span>
                            <strong>${formatBR(c.saldoTotal)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Desconto Aplicado (${c.desc.toFixed(0)}%)</span>
                            <strong style="color: #10b981;">- ${formatBR(c.valorDescontoAplicado)}</strong>
                        </div>
                        ${c.descontoParaDebito > 0 ? `
                        <div class="scenario-detail" style="background: #fef3c7; padding: 6px; border-radius: 4px; border-left: 3px solid #f59e0b;">
                            <span>Desconto p/ D√©bito (+${c.descontoParaDebito.toFixed(0)}%)</span>
                            <strong style="color: #f59e0b;">- ${formatBR(c.valorDescontoDebito)}</strong>
                        </div>
                        ` : ''}
                        <div class="scenario-detail">
                            <span>Saldo Consignado</span>
                            <strong>${formatBR(c.saldoConsignado)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Montante (${c.prazo}x)</span>
                            <strong>${formatBR(c.montante)}</strong>
                        </div>
                        <div class="scenario-detail">
                            <span>Custo da Opera√ß√£o</span>
                            <strong>${formatBR(c.custo)}</strong>
                        </div>
                        <div class="scenario-detail" style="font-size: 10px; color: #888;">
                            <span>Desconto M√°x. (${c.prazo}m)</span>
                            <strong>${c.maxDescPrazo.toFixed(2)}%</strong>
                        </div>
                        
                        ${c.cabeNaMargem ? `
                        <div class="result-box">
                            <div class="result-title">‚úÖ CABE NA MARGEM</div>

                            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 4px; margin: 8px 0;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 6px; font-weight: 600;">üí∞ CONSIGNADO</div>
                                <div class="result-row" style="border: none;">
                                    <span>PMT Consignado (${c.prazo}x):</span>
                                    <strong>${formatBR(c.pmtConsignado)}</strong>
                                </div>
                                <div class="result-row" style="border: none; font-weight: 600;">
                                    <span>Total Consignado:</span>
                                    <strong>${formatBR(c.montanteConsignado)}</strong>
                                </div>
                                <div class="result-row" style="border: none; margin-top: 4px;">
                                    <span>Margem Dispon√≠vel:</span>
                                    <strong>${formatBR(margem)}</strong>
                                </div>
                                <div class="result-row" style="background: rgba(255, 255, 255, 0.3); padding: 6px; border-radius: 4px; margin-top: 6px; border: none;">
                                    <span style="font-weight: 600; color: white;">üí∞ Margem Sobrando:</span>
                                    <strong style="color: white; font-size: 14px;">${formatBR(c.margemSobrando)}</strong>
                                </div>
                            </div>

                            ${c.valorDescontoAplicado > 0 ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 4px; margin: 8px 0;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 6px; font-weight: 600;">üí≥ D√âBITO DO DESCONTO (${c.desc.toFixed(0)}%)</div>
                                <div class="result-row" style="border: none;">
                                    <span>PMT D√©bito (${c.prazoDebito}x):</span>
                                    <strong>${formatBR(c.pmtDebito)}</strong>
                                </div>
                                <div class="result-row" style="border: none; font-weight: 600;">
                                    <span>Total D√©bito:</span>
                                    <strong>${formatBR(c.valorTotalDebito)}</strong>
                                </div>
                            </div>
                            ` : ''}

                            <div class="result-total">
                                <div style="font-size: 10px; opacity: 0.8;">PARCELA MENSAL TOTAL</div>
                                <div class="result-total-value">${formatBR(c.totalMensal)}</div>
                                <div style="font-size: 11px; opacity: 0.9; margin-top: 6px; line-height: 1.4;">
                                    ${c.pmtDebito > 0 ?
                                        `<strong>${formatBR(c.pmtConsignado)}</strong> Consignado<br>+ <strong>${formatBR(c.pmtDebito)}</strong> D√©bito em Conta`
                                        : 'Apenas Consignado'}
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="result-box" style="background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);">
                            <div class="result-title">üí≥ REQUER D√âBITO EM CONTA</div>

                            <div style="background: rgba(255, 255, 255, 0.25); padding: 8px; border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">‚ö†Ô∏è</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 10px; opacity: 0.9; font-weight: 600;">ATEN√á√ÉO</div>
                                    <div style="font-size: 12px; opacity: 0.95;">Desconto aplicado + adicional para d√©bito</div>
                                </div>
                            </div>

                            ${c.descontoParaDebito > 0 ? `
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid rgba(255, 255, 255, 0.5);">
                                <div style="font-size: 11px; color: white; margin-bottom: 4px; font-weight: 600; opacity: 0.95;">üìä Composi√ß√£o dos Descontos</div>
                                <div style="font-size: 11px; color: white; opacity: 0.9;">
                                    ‚Ä¢ Desconto aplicado: <strong>${c.desc.toFixed(0)}%</strong> = ${formatBR(c.valorDescontoAplicado)}<br>
                                    ‚Ä¢ Desconto p/ d√©bito: <strong>+${c.descontoParaDebito.toFixed(0)}%</strong> = ${formatBR(c.valorDescontoDebito)}<br>
                                    ‚Ä¢ <strong>Total d√©bito:</strong> ${formatBR(c.saldoDebito)}
                                </div>
                            </div>
                            ` : ''}

                            <div style="background: rgba(255,255,255,0.15); padding: 8px; border-radius: 4px; margin: 8px 0;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 6px; font-weight: 600;">üí∞ CONSIGNADO</div>
                                <div class="result-row" style="border: none;">
                                    <span>PMT Consignado (${c.prazo}x):</span>
                                    <strong>${formatBR(c.pmtConsignado)}</strong>
                                </div>
                                <div class="result-row" style="border: none; font-weight: 600;">
                                    <span>Total Consignado:</span>
                                    <strong>${formatBR(c.montanteConsignado)}</strong>
                                </div>
                            </div>

                            <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 4px; margin: 8px 0;">
                                <div style="font-size: 11px; opacity: 0.9; margin-bottom: 6px; font-weight: 600;">üí≥ D√âBITO EM CONTA</div>
                                <div class="result-row" style="border: none;">
                                    <span>PMT D√©bito (${c.prazoDebito}x):</span>
                                    <strong>${formatBR(c.pmtDebito)}</strong>
                                </div>
                                <div class="result-row" style="border: none; font-weight: 600;">
                                    <span>Total D√©bito:</span>
                                    <strong>${formatBR(c.valorTotalDebito)}</strong>
                                </div>
                            </div>
                            <div class="result-total">
                                <div style="font-size: 10px; opacity: 0.8;">PARCELA MENSAL TOTAL</div>
                                <div class="result-total-value">${formatBR(c.totalMensal)}</div>
                                <div style="font-size: 11px; opacity: 0.9; margin-top: 6px; line-height: 1.4;">
                                    <strong>${formatBR(c.pmtConsignado)}</strong> Consignado<br>+ <strong>${formatBR(c.pmtDebito)}</strong> D√©bito em Conta
                                </div>
                            </div>
                        </div>
                        `}
                    `;
                    const btn = document.createElement('button');
                    btn.className = 'btn-detail';
                    btn.textContent = 'Ver Parcelas';
                    btn.onclick = () => mostrarParcelas(i);
                    card.appendChild(btn);
                    grid.appendChild(card);
                });
        }
        
        function gerarDetalhamento() {
            if (!window.dadosGlobais || !window.cenariosCalculados) {
                alert('Calcule os cen√°rios primeiro!');
                return;
            }
            
            const { saldoTotal, margem, taxa } = window.dadosGlobais;
            const cenariosViaveis = window.cenariosCalculados.slice(0, 5);
            
            if (cenariosViaveis.length === 0) {
                alert('Nenhum cen√°rio vi√°vel encontrado!');
                return;
            }
            
            let detalhamento = `Total das responsabilidades a pagar: ${formatBR(saldoTotal)}
Margem Consign√°vel: ${formatBR(margem)}
Taxa: ${taxa.toFixed(2)}% a.m.

`;
            
            cenariosViaveis.forEach((dados, index) => {
                detalhamento += `Proposta ${index + 1}:\n`;
                
                if (!dados.cabeNaMargem) {
                    // Proposta com d√©bito em conta
                    detalhamento += `Opera√ß√£o consignada em ${dados.prazo}x de ${formatBR(dados.pmtConsignado)} + opera√ß√£o cobrada mediante d√©bito em conta em ${dados.prazoDebito}x de ${formatBR(dados.pmtDebito)}\n`;
                        detalhamento += `Parcela mensal total: ${formatBR(dados.pmtConsignado + dados.pmtDebito)}\n`;
                        detalhamento += `Taxa de ${taxa.toFixed(2)}% a.m.\n\n`;
                } else {
                    // Proposta s√≥ consignado
                    detalhamento += `Opera√ß√£o consignada em ${dados.prazo}x de ${formatBR(dados.pmtConsignado)}\n`;
                    detalhamento += `Taxa de ${taxa.toFixed(2)}% a.m.\n\n`;
                }
            });
            
            // Criar modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative;">
                    <button onclick="fecharModal()" style="position: absolute; top: 15px; right: 15px; background: #dc2626; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;">√ó</button>
                    
                    <h2 style="color: #b8860b; margin-bottom: 20px; font-size: 24px;">üìã Detalhamento das Propostas</h2>
                    
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #b8860b;">
                        <pre style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; margin: 0; white-space: pre-wrap; color: #1f2937;">${detalhamento}</pre>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="copiarDetalhamento()" style="flex: 1; background: #b8860b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            üìã Copiar Texto
                        </button>
                        <button onclick="fecharModal()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            Fechar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Salvar refer√™ncia ao modal para fechar
            window.modalAtual = modal;
            
            // Salvar detalhamento para copiar
            window.detalhamentoTexto = detalhamento;
        }
        
        function fecharModal() {
            if (window.modalAtual) {
                window.modalAtual.remove();
                window.modalAtual = null;
            }
        }
        
        function copiarDetalhamento() {
            navigator.clipboard.writeText(window.detalhamentoTexto).then(() => {
                alert('‚úÖ Detalhamento copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                alert('‚ùå Erro ao copiar. Tente selecionar o texto manualmente.');
            });
        }

        function filtrarCenarios(filtro) {
            const margem = window.margemAtual;
            let cenariosFiltrados;

            if (filtro === 'todos') {
                cenariosFiltrados = window.todosCenarios;
            } else if (filtro === 'viavel') {
                cenariosFiltrados = window.todosCenarios.filter(c => c.viavel);
            } else if (filtro === 'reforco') {
                cenariosFiltrados = window.todosCenarios.filter(c => !c.viavel);
            } else {
                // Filtro por prazo espec√≠fico
                cenariosFiltrados = window.todosCenarios.filter(c => c.prazo === filtro);
            }

            // Atualizar estilos dos bot√µes
            document.querySelectorAll('.btn-filtro').forEach(btn => {
                if (btn.getAttribute('data-filtro') == filtro) {
                    btn.style.background = '#C4A35A';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = '#e2e8f0';
                    btn.style.color = '#334155';
                }
            });

            renderizarCenarios(cenariosFiltrados, margem);
        }

        function mostrarParcelas(index) {
            const c = window.cenariosExibir[index];
            if (!c) return;
            const consLen = c.prazo;
            const debLen = c.prazoDebito || 0;
            const maxMeses = Math.max(consLen, debLen);
            const totalCons = c.pmtConsignado * consLen;
            const totalDeb = c.pmtDebito * debLen;

            let rows = '';
            for (let m = 1; m <= maxMeses; m++) {
                const cons = m <= consLen ? c.pmtConsignado : 0;
                const deb = (m <= debLen) ? c.pmtDebito : 0;
                const tot = cons + deb;
                rows += `<tr><td style="text-align:left;">${m}</td><td>${formatBR(cons)}</td><td>${formatBR(deb)}</td><td>${formatBR(tot)}</td></tr>`;
            }

            const resumo = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 12px;">
                    <div class="info-card">
                        <div class="info-card-label">Saldo Original</div>
                        <div class="info-card-value">${formatBR(c.saldoTotal)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-label">Desconto (${c.desc}%)</div>
                        <div class="info-card-value" style="color: #dc2626;">- ${formatBR(c.valorDesconto)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-label">Saldo a Negociar</div>
                        <div class="info-card-value">${formatBR(c.saldoComDesconto)}</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 12px;">
                    <div class="info-card" style="border-top-color: #10b981;">
                        <div class="info-card-label">üí∞ Consignado (${consLen}x)</div>
                        <div class="info-card-value" style="color: #10b981;">${formatBR(c.pmtConsignado)}/m√™s</div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">Total: ${formatBR(totalCons)}</div>
                    </div>
                    ${c.pmtDebito > 0 ? `
                    <div class="info-card" style="border-top-color: #3b82f6;">
                        <div class="info-card-label">üí≥ D√©bito (${debLen}x)</div>
                        <div class="info-card-value" style="color: #3b82f6;">${formatBR(c.pmtDebito)}/m√™s</div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">Total: ${formatBR(totalDeb)}</div>
                    </div>
                    ` : ''}
                    <div class="info-card" style="border-top-color: #C4A35A;">
                        <div class="info-card-label">üìä Total Mensal</div>
                        <div class="info-card-value" style="color: #C4A35A;">${formatBR(c.totalMensal)}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">Montante: ${formatBR(totalCons + totalDeb)}</div>
                    </div>
                </div>

                ${c.pmtDebito > 0 ? `
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; border-left: 4px solid #f59e0b; margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 4px;">üí° Composi√ß√£o do D√©bito em Conta:</div>
                    ${c.pmtDescontoDebito > 0 ? `
                    <div style="font-size: 11px; color: #78350f;">
                        ‚Ä¢ D√≠vida do Desconto (${c.desc}%): <strong>${formatBR(c.pmtDescontoDebito)}/m√™s</strong>
                    </div>
                    ` : ''}
                    ${c.pmtDebitoSobra > 0 ? `
                    <div style="font-size: 11px; color: #78350f;">
                        ‚Ä¢ Sobra do Saldo (n√£o coube): <strong>${formatBR(c.pmtDebitoSobra)}/m√™s</strong>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;

            document.getElementById('modal-title').innerHTML = `Parcelas ‚Äî ${c.prazo}x Consignado ${c.desc.toFixed(0)}%${c.pmtDebito > 0 ? ` + ${c.prazoDebito}x D√©bito` : ''}`;
            document.getElementById('modal-body').innerHTML = `
                ${resumo}
                <div style="max-height:60vh; overflow:auto;">
                    <table class="table">
                        <thead><tr><th>M√™s</th><th>Consignado</th><th>D√©bito</th><th>Total</th></tr></thead>
                        <tbody>${rows}</tbody>
                        <tfoot>
                            <tr><th style="text-align:left;">Totais</th><th>${formatBR(totalCons)}</th><th>${formatBR(totalDeb)}</th><th>${formatBR(totalCons + totalDeb)}</th></tr>
                        </tfoot>
                    </table>
                </div>
            `;
            document.getElementById('parcelas-modal').style.display = 'flex';
            window.parcelasAtual = { index, maxMeses, consLen, debLen, pmtCons: c.pmtConsignado, pmtDeb: c.pmtDebito };
        }
        function fecharParcelas() {
            document.getElementById('parcelas-modal').style.display = 'none';
            window.parcelasAtual = null;
        }
        function exportarParcelas() {
            const pa = window.parcelasAtual;
            if (!pa) return;
            const c = window.cenariosExibir[pa.index];
            const max = pa.maxMeses;
            let csv = 'Mes;Consignado;Debito;Total\n';
            for (let m = 1; m <= max; m++) {
                const cons = m <= pa.consLen ? pa.pmtCons : 0;
                const deb = m <= pa.debLen ? pa.pmtDeb : 0;
                const tot = cons + deb;
                const f = (v) => v.toFixed(2).replace('.', ',');
                csv += `${m};${f(cons)};${f(deb)};${f(tot)}\n`;
            }
            csv += `Totais;${(pa.pmtCons * pa.consLen).toFixed(2).replace('.', ',')};${(pa.pmtDeb * pa.debLen).toFixed(2).replace('.', ',')};${((pa.pmtCons * pa.consLen) + (pa.pmtDeb * pa.debLen)).toFixed(2).replace('.', ',')}\n`;
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `parcelas_${c.prazo}x_${c.desc.toFixed(0)}pct.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
